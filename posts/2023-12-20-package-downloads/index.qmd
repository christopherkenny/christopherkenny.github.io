---
title: "Packages 2023 Wrapped"
date: "2023-12-20"
description: |
  A quick look at my R package updates this year.
categories: [r-pkg]
image: "hex_feltr.png"
image-alt: "A hexagonal logo for the R package Feltr with the word feltr in the foreground and a small map in the background."
editor: 
  markdown: 
    wrap: sentence
---

```{r}
#| label: libs
library(tidyverse)
library(gt)
```

```{r}
#| label: helpers
make_url <- function(x, y, .tb = pkgs) {
  paste0('<a href="', .tb %>% filter(logo %in% x) %>% slice(match(logo, x)) %>% pull(link), '">', y, '</a>')
}
```

```{r}
#| label: data
pkgs <- read_csv('pkgs.csv') |> 
  mutate(logo = paste0('../../', logo)) # set to higher level directory
counts_lst_yr <- pkgs %>%
  filter(status == 'CRAN') %>%
  pull(name) %>%
  cranlogs::cran_downloads(from = '2023-01-01') %>%
  group_by(package) %>%
  summarize(count = sum(count)) %>%
  rename(name = package) |> 
  arrange(desc(count)) |> 
  left_join(pkgs, by = 'name')

hists <- pkgs |> 
  filter(status == 'CRAN') |> 
  pull(name) |> 
  map(pkgsearch::cran_package_history) |> 
  list_rbind()

hists <- hists |> 
  mutate(
    year = year(date),
    date2 = date(date)
  )

```


```{r} 
counts_lst_yr  |> 
  select(logo, info, count) |>
  mutate(rank = row_number(), .before = everything()) |> 
  gt()  |> 
  text_transform(
    locations = cells_body(columns = logo),
    fn = function(x) {
      make_url(x, y = 
                 local_image(
                   filename = x,
                   height = 100
                 )
      )
    }
  ) |> 
  fmt_number(columns = count, decimals = 0) |> 
  cols_width(
    logo ~ px(80)
  ) |> 
  cols_label(
    rank = 'Rank',
    logo = '',
    info = 'Package',
    count = 'Downloads'
  )
```

